<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css" />
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">

    <title>Task List Laravel</title>
    
</head>
<body>
    
    <!-- Navigation bar  -->
    <nav class="navbar navbar-expand-lg bg-dark navbar-dark py-3 mb-3">
        <div class="container">
            <a href="#" class="navbar-brand">Task List Laravel</a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navmenu">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navmenu">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a href="#profile" class="nav-link" id="profile">Profile</a>
                    </li>
                    <li class="nav-item">
                        <a href="#questions" class="nav-link" id="tasks">Tasks</a>
                    </li>
                    <li class="nav-item">
                        <a href="#questions" class="nav-link" id="addTask">Add Task</a>
                    </li>
                    <li class="nav-item">
                        <a href="#instructions" class="nav-link" id="logout">Logout</a>
                    </li>
                </ul>
            </div>

        </div>
    </nav>

    <!-- Search, sort filter section -->
    <section class="m-auto mb-3" id="containerFilter">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card border-opacity-25 shadow">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-xs-12 mb-3">
                                    <input type="text" class="form-control" placeholder="Search..." data-task-search>
                                </div>
                                <div class="col">
                                    <div class="d-flex justify-content-end align-items-center">
                                        <p class="small mb-0 me-2 text-muted">Filter</p>
                                        <select class="select" data-task-filter>
                                            <option value="1">All</option>
                                            <option value="2">Completed</option>
                                            <option value="3">Active</option>
                                        </select>
                                        <p class="small mb-0 ms-4 me-2 text-muted">Sort</p>
                                        <select class="select" data-task-sort>
                                            <option value="1">Updated date Desc</option>
                                            <option value="2">Updated date Asc</option>
                                            <option value="3">Due date Desc</option>
                                            <option value="4">Due date Asc</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- card data -->
    <main class="m-auto" id="containerTaskList">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-6" id="cardList">
                    <div class="card border-opacity-25 shadow mb-3" id="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="card-title" id="cardTitle">The modern card</h5>
                                <div class="dropdown mb-2">
                                <a class="btn btn-light btn-sm dropdown-toggle border border-secondary border-opacity-10" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="pb-2"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#494949" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-settings">
                                        <circle cx="12" cy="12" r="3"></circle>
                                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                                    </svg></i>
                                </a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" id="linkEdit">Edit</a></li>
                                    <li><a class="dropdown-item" href="#" id="linkDelete">Delete</a></li>
                                    <li><a class="dropdown-item" href="#" id="linkCompleted">Mark as Completed</a></li>
                                </ul>
                                </div>
                            </div>
                            

                            <p class="card-text" id="cardText">Lorem ipsum dolor sit amet, consectetur adipisicing elit. Atque commodi debitis eaque explicabo fuga maiores necessitatibus, neque omnis optio vel!</p>
                
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted" id="cardUpdatedText">
                                    Updated: 2023/02/23
                                </small>
                                <small class="text-muted" id="cardDueDateText">
                                    Due: 2023/02/23
                                </small>
                            </div>
                            <div class="d-flex justify-content-end align-items-center">
                                <span class="badge rounded-pill bg-success" data-card-completed>completed</span>
                            </div>
                            
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Login form -->
    <main class="m-auto" id="containerLoginForm">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card border-opacity-25 shadow">
                        <div class="card-body">
                            <form id="loginForm">
                                <!-- Email input -->
                                <div class="mb-3">
                                    <input type="email" class="form-control" id="inputEmail" placeholder="Email address">
                                </div>
            
                                <!-- Password input -->
                                <div class="mb-3">
                                    <input type="password" class="form-control" id="inputPassword" placeholder="Password">
                                </div>
            
                                <!-- Submit button -->
                                <div class="d-grid gap-2 mb-3">
                                    <button class="btn btn-outline-primary" type="submit" id="login">Login</button>
                                </div>
            
                                <!-- Register button -->
                                <div class="text-center">
                                    <p>Not a member? <a href="#!" id="registerLink">Register</a></p>
                                </div>
            
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Register form -->
    <main class="m-auto" id="containerRegisterForm">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card border-opacity-25 shadow">
                        <div class="card-body">
                            <form id="registerForm">
                                <!-- Email input -->
                                <div class="mb-3">
                                    <label for="inputName" class="form-label">Username</label>
                                    <input type="text" class="form-control" id="inputName">
                                </div>
            
                                <!-- Email input -->
                                <div class="mb-3">
                                    <label for="inputEmail" class="form-label">Email address</label>
                                    <input type="email" class="form-control" id="inputEmail">
                                </div>
            
                                <!-- Password input -->
                                <div class="mb-3">
                                    <label for="inputPassword" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="inputPassword">
                                </div>
            
                                <!-- Password confirmation input -->
                                <div class="mb-3">
                                    <label for="inputPasswordConfirmation" class="form-label">Confirm Password</label>
                                    <input type="password" class="form-control" id="inputPasswordConfirmation">
                                </div>
            
                                <!-- Submit button -->
                                <div class="d-grid gap-2 mb-3">
                                    <button class="btn btn-outline-primary" type="submit" id="register">Register</button>
                                </div>
            
                                <!-- Register button -->
                                <div class="text-center">
                                    <p>Are you a member? <a href="#!" id="loginLink">Login</a></p>
                                </div>
            
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Profile form -->
    <main class="m-auto" id="containerProfileForm">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card border-opacity-25 shadow">
                        <div class="card-body">
                            <form id="profileForm">
                                <!-- Email input -->
                                <div class="mb-3">
                                    <label for="inputName" class="form-label">Username</label>
                                    <input type="text" class="form-control" id="inputName">
                                </div>
            
                                <!-- Email input -->
                                <div class="mb-3">
                                    <label for="inputEmail" class="form-label">Email address</label>
                                    <input type="email" class="form-control" id="inputEmail">
                                </div>
            
                                <!-- Password input -->
                                <div class="mb-3">
                                    <label for="inputPassword" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="inputPassword">
                                </div>
            
                                <!-- Password confirmation input -->
                                <div class="mb-3">
                                    <label for="inputPasswordConfirmation" class="form-label">Confirm Password</label>
                                    <input type="password" class="form-control" id="inputPasswordConfirmation">
                                </div>
            
                                <!-- Submit button -->
                                <div class="d-grid gap-2 mb-3">
                                    <button class="btn btn-outline-primary" type="submit" id="update">Update</button>
                                </div>

                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Create task form -->
    <main class="m-auto" id="containerCreateTaskForm">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card border-opacity-25 shadow">
                        <div class="card-body">
                            <form id="createTaskForm">
                                <!-- Title input -->
                                <div class="mb-3">
                                    <input type="text" class="form-control" id="inputTitle" placeholder="Title">
                                </div>

                                <!-- Description input -->
                                <div class="mb-3">
                                    <textarea class="form-control" id="inputDescription" rows="3" placeholder="Description"></textarea>
                                </div>

                                <!-- Completed input -->
                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="inputCompleted">
                                    <label class="form-check-label" for="completed">Mark as completed</label>
                                </div>

                                <!-- Due Date input -->
                                <div class="mb-3">
                                    <label for="inputDueDate" class="form-label">Due Date</label>
                                    <input type="date" class="form-control" id="inputDueDate" value="">
                                </div>
            
                                <!-- Submit button -->
                                <div class="d-grid gap-2 mb-3">
                                    <button class="btn btn-outline-primary" type="submit" id="createTask">Save</button>
                                </div>

                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Edit task form -->
    <main class="m-auto" id="containerEditTaskForm">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card border-opacity-25 shadow">
                        <div class="card-body">
                            <form id="editTaskForm">
                                <!-- Title input -->
                                <div class="mb-3">
                                    <input type="text" class="form-control" id="inputTitle" placeholder="Title">
                                </div>

                                <!-- Description input -->
                                <div class="mb-3">
                                    <textarea class="form-control" id="inputDescription" rows="3" placeholder="Description"></textarea>
                                </div>

                                <!-- Completed input -->
                                <div class="mb-3 form-check">
                                    <input type="checkbox" class="form-check-input" id="inputCompleted">
                                    <label class="form-check-label" for="completed">Mark as completed</label>
                                </div>

                                <!-- Due Date input -->
                                <div class="mb-3">
                                    <label for="dueDate" class="form-label">Due Date</label>
                                    <input type="date" class="form-control" id="inputDueDate" value="">
                                </div>
            
                                <!-- Submit button -->
                                <div class="d-grid gap-2 mb-3">
                                    <button class="btn btn-outline-primary" type="submit" id="updateTask">Update</button>
                                </div>

                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN" crossorigin="anonymous"></script>
    <script type="text/javascript">

        document.addEventListener("DOMContentLoaded", setup);

        function setup() {

            const ACCESS_TOKEN = 'tasks.access_token';
            const API_URI = 'http://localhost/api';

            // select DOM elements
            const buttonProfile = document.getElementById('profile');
            const buttonTasks = document.getElementById('tasks');
            const buttonAddTask = document.getElementById('addTask');
            const buttonLogout = document.getElementById('logout');
            const registerLink = document.getElementById('registerLink');
            const loginLink = document.getElementById('loginLink');

            const layoutContainerFilter = document.getElementById('containerFilter');
            const layoutContainerTaskList = document.getElementById('containerTaskList');
            const layoutContainerLoginForm = document.getElementById('containerLoginForm');
            const layoutContainerRegisterForm = document.getElementById('containerRegisterForm');
            const layoutContainerCreateTaskForm = document.getElementById('containerCreateTaskForm');
            const layoutContainerProfileForm = document.getElementById('containerProfileForm');
            const layoutContainerEditTaskForm = document.getElementById('containerEditTaskForm');

            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const profileForm = document.getElementById('profileForm');
            const createTaskForm = document.getElementById('createTaskForm');
            const editTaskForm = document.getElementById('editTaskForm');
            
            const cardList = document.getElementById('cardList');
            const card = document.getElementById('card');
            
            const buttonLogin = document.getElementById('login');
            const buttonRegister = document.getElementById('register');
            const buttonUpdateProfile = document.getElementById('update');
            const buttonCreateTask = document.getElementById('createTask');
            const buttonUpdateTask = document.getElementById('updateTask');

            const searchFilter = document.querySelector('[data-task-search]');
            const customFilter = document.querySelector('[data-task-filter]');
            const sortFilter = document.querySelector('[data-task-sort]');
            

            card.style.display = 'none';

            buttonProfile.style.display = 'none';
            buttonTasks.style.display = 'none';
            buttonAddTask.style.display = 'none';
            buttonLogout.style.display = 'none';

            layoutContainerFilter.style.display = 'none';
            layoutContainerTaskList.style.display = 'none';
            //layoutContainerLoginForm.style.display = 'none';
            layoutContainerRegisterForm.style.display = 'none';
            layoutContainerProfileForm.style.display = 'none';
            layoutContainerCreateTaskForm.style.display = 'none';
            layoutContainerEditTaskForm.style.display = 'none';

            let user;
            let task;

            function getFilters() {
                const filters = {};
                if (searchFilter.value.length >= 1) {
                    filters['search'] = searchFilter.value;
                }

                if (customFilter.value !== '1') {
                    filters['custom'] = customFilter.value;
                }

                if (sortFilter.value !== '1') {
                    filters['sort'] = sortFilter.value;
                }

                return filters;
            }

            function getTasksWithFilters(filters) {
                let queryString = '';
                if (filters.search !== undefined) {
                    queryString = queryString + `search=${filters.search}`;
                }

                if (filters.custom !== undefined) {
                    switch (filters['custom']) {
                        case '1':
                            break;
                        case '2':
                            // completed only
                            queryString = queryString ? `${queryString}&completed=1` : `completed=1`;
                            break;
                        case '3':
                            // incompleted only
                            queryString = queryString ? `${queryString}&completed=0` : `completed=0`;
                            break;
                        default:
                            break;
                    }
                }

                if (filters.sort !== undefined) {
                    switch (filters['sort']) {
                        case '1':
                            break;
                        case '2':
                            queryString = queryString ? `${queryString}&sort=updatedAt&direction=asc` : `sort=updatedAt&direction=asc`;
                            break;
                        case '3':
                            queryString = queryString ? `${queryString}&sort=dueDate&direction=desc` : `sort=dueDate&direction=desc`;
                            break;
                        case '4':
                            queryString = queryString ? `${queryString}&sort=dueDate&direction=asc` : `sort=dueDate&direction=asc`;
                            break;
                        default:
                            break;
                    }
                }

                queryString = queryString ? `?${queryString}` : '';
                getTasks(queryString);
            }

            /* Event listeners */

            searchFilter.addEventListener('keyup', (e) => {
                e.preventDefault();
                getTasksWithFilters(getFilters());
            });

            customFilter.addEventListener('change', (e) => {
                e.preventDefault();
                getTasksWithFilters(getFilters());
            });

            sortFilter.addEventListener('change', (e) => {
                e.preventDefault();
                getTasksWithFilters(getFilters());
            });

            cardList.addEventListener('click', (e) => {
                e.preventDefault();
                const uiElement = e.target;
                if (uiElement instanceof HTMLAnchorElement && uiElement.innerHTML === 'Edit') {
                    const selectedCard = e.target.closest('#card');
                    
                    layoutContainerTaskList.style.display = 'none';
                    getTask(selectedCard.dataset.cardId);

                } else if (uiElement instanceof HTMLAnchorElement && uiElement.innerHTML === 'Delete') {
                    const selectedCard = e.target.closest('#card');
                    deleteTask(selectedCard.dataset.cardId);
                }

            });

            buttonProfile.addEventListener('click', (e) => {
                e.preventDefault();
                getUser();
            });

            buttonLogin.addEventListener('click', async (e) => {
                e.preventDefault();
                loginUser();
            });

            buttonRegister.addEventListener('click', async (e) => {
                e.preventDefault();
                registerUser();
            });

            buttonUpdateProfile.addEventListener('click', async (e) => {
                e.preventDefault();
                updateUser();
            });

            buttonLogout.addEventListener('click', async (e) => {
                e.preventDefault();
                logoutUser();
            });

            buttonTasks.addEventListener('click', async (e) => {
                e.preventDefault();
                getTasks('');
            });

            buttonAddTask.addEventListener('click', async (e) => {
                e.preventDefault();
                renderCreateTaskForm();
            });

            buttonCreateTask.addEventListener('click', async (e) => {
                e.preventDefault();
                createTask();
            });

            buttonUpdateTask.addEventListener('click', async (e) => {
                e.preventDefault();
                updateTask();
            });

            registerLink.addEventListener('click', async (e) => {
                e.preventDefault();
                renderRegisterForm();
            });

            loginLink.addEventListener('click', async (e) => {
                e.preventDefault();
                renderDefaultView();
            });

            /* Render views */

            function defaultViews() {
                const token = localStorage.getItem(ACCESS_TOKEN);
                if (token) {
                    getTasks('');
                } else {
                    renderDefaultView();
                }
            }

            function renderDefaultView() {
                layoutContainerFilter.style.display = 'none';
                layoutContainerTaskList.style.display = 'none';
                layoutContainerLoginForm.style.display = 'block';
                layoutContainerRegisterForm.style.display = 'none';
                layoutContainerProfileForm.style.display = 'none';
                layoutContainerEditTaskForm.style.display = 'none';
                buttonProfile.style.display = 'none';
                buttonTasks.style.display = 'none';
                buttonAddTask.style.display = 'none';
                buttonLogout.style.display = 'none';
            }

            function renderTaskList(tasks, resetFilters) {
                layoutContainerLoginForm.style.display = 'none';
                layoutContainerRegisterForm.style.display = 'none';
                layoutContainerCreateTaskForm.style.display = 'none';
                layoutContainerProfileForm.style.display = 'none';
                layoutContainerEditTaskForm.style.display = 'none';
                layoutContainerFilter.style.display = "block";
                layoutContainerTaskList.style.display = "block";

                buttonProfile.style.display = "block";
                buttonTasks.style.display = "block";
                buttonAddTask.style.display = "block";
                buttonLogout.style.display = "block";

                // reset all ui tasks
                while (cardList.firstChild) {
                    cardList.removeChild(cardList.firstChild);
                }

                if (resetFilters) {
                    clearFilters();
                }

                tasks.forEach(task => {
                    const newCard = card.cloneNode(true);
                    newCard.dataset.cardId = task.id;
                    newCard.querySelector('[id^="cardTitle"]').innerHTML = task.title;
                    newCard.querySelector('[id^="cardText"]').innerHTML = task.description;
                    newCard.querySelector('[id^="cardUpdatedText"]').innerHTML = `Updated: ${task.updatedAt}`;
                    newCard.querySelector('[id^="cardDueDateText"]').innerHTML = `Due: ${task.dueDate}`;
                    if (!task.completed) {
                        newCard.querySelector('[data-card-completed]').innerHTML= '';
                    }
                    
                    newCard.style.display = 'block';
                    cardList.appendChild(newCard);
                });
            }

            function renderCreateTaskForm() {
                layoutContainerLoginForm.style.display = 'none';
                layoutContainerRegisterForm.style.display = 'none';
                layoutContainerProfileForm.style.display = 'none';
                layoutContainerFilter.style.display = 'none';
                layoutContainerTaskList.style.display = 'none';
                layoutContainerEditTaskForm.style.display = 'none';
                layoutContainerCreateTaskForm.style.display = 'block';
            }

            function renderRegisterForm() {
                layoutContainerLoginForm.style.display = 'none';
                layoutContainerRegisterForm.style.display = 'block';
                layoutContainerProfileForm.style.display = 'none';
                layoutContainerFilter.style.display = 'none';
                layoutContainerTaskList.style.display = 'none';
                layoutContainerEditTaskForm.style.display = 'none';
                layoutContainerCreateTaskForm.style.display = 'none';
            }

            function renderProfileForm(user) {
                layoutContainerLoginForm.style.display = 'none';
                layoutContainerRegisterForm.style.display = 'none';
                layoutContainerProfileForm.style.display = 'none';
                layoutContainerFilter.style.display = 'none';
                layoutContainerTaskList.style.display = 'none';
                layoutContainerCreateTaskForm.style.display = 'none';
                layoutContainerEditTaskForm.style.display = 'none';
                layoutContainerProfileForm.style.display = 'block';

                profileForm.inputName.value = user.name;
                profileForm.inputEmail.value = user.email;
                profileForm.inputPassword.value = '';
                profileForm.inputPasswordConfirmation.value = '';
            }

            function renderEditTaskForm(task) {
                layoutContainerLoginForm.style.display = 'none';
                layoutContainerRegisterForm.style.display = 'none';
                layoutContainerProfileForm.style.display = 'none';
                layoutContainerFilter.style.display = 'none';
                layoutContainerTaskList.style.display = 'none';
                layoutContainerCreateTaskForm.style.display = 'none';
                layoutContainerProfileForm.style.display = 'none';
                layoutContainerEditTaskForm.style.display = 'block';

                editTaskForm.inputTitle.value = task.title;
                editTaskForm.inputDescription.value = task.description ?? '';
                editTaskForm.inputDueDate.value = task.dueDate ?  task.dueDate .split(" ")[0] : null;
                editTaskForm.inputCompleted.checked = task.completed;
            }

            function clearLoginForm(success) {
                loginForm.inputPassword.value = '';
                if (success) {
                    loginForm.inputEmail.value = '';
                }
            }

            function clearRegisterForm(success) {
                registerForm.inputPassword.value = '';
                registerForm.inputPasswordConfirmation.value = '';
                if (success) {
                    registerForm.inputName.value = '';
                    registerForm.inputEmail.value = '';
                }
            }

            function clearCreateTaskForm() {
                createTaskForm.inputTitle.value = '';
                createTaskForm.inputDescription.value = '';
                createTaskForm.inputCompleted.checked = false;
                createTaskForm.inputDueDate.value = '';
            }

            function clearProfileForm() {
                profileForm.inputPassword.value = '';
                profileForm.inputPasswordConfirmation.value = '';
            }

            function clearEditTaskForm() {
                editTaskForm.inputTitle.value = '';
                editTaskForm.inputDescription.value = '';
                editTaskForm.inputCompleted.checked = false;
                editTaskForm.inputDueDate.value = '';
            }

            function clearFilters() {
                searchFilter.value = '';
                customFilter.value = 1;
                sortFilter.value = 1;
            }

            /* [API CALLS] */

            async function getTasks(queryString) {
                const response = await fetch(`${API_URI}/tasks${queryString}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem(ACCESS_TOKEN)
                    },
                });

                const json = await response.text();
                const obj = JSON.parse(json);
                    
                if (response.ok) {
                    let tasks = obj.data;
                    const resetFilters = queryString.length === 0;
                    renderTaskList(tasks, resetFilters);
                } else {
                    localStorage.removeItem(ACCESS_TOKEN);
                    renderDefaultView();
                }
            }

            async function getTask(taskId) {
                const response = await fetch(`${API_URI}/tasks/${taskId}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem(ACCESS_TOKEN)
                    },
                });

                const json = await response.text();
                const obj = JSON.parse(json);
                    
                if (response.status == 200) {
                    task = obj.data;
                    renderEditTaskForm(task);
                } else {
                    alert(obj.message);
                }
            }

            async function updateTask() {
                const payload = {};
                taskId = task.id;

                let description = editTaskForm.inputDescription.value ? editTaskForm.inputDescription.value : null;
                let dueDate = editTaskForm.inputDueDate.value ? editTaskForm.inputDueDate.value : null;

                if (task && task.title !== editTaskForm.inputTitle.value) {
                    payload['title'] = editTaskForm.inputTitle.value;
                }
                
                if (task && task.description !== description) {
                    payload['description'] = description;
                }

                if (task && task.completed !== editTaskForm.inputCompleted.checked) {
                    payload['completed'] = editTaskForm.inputCompleted.checked;
                }

                if (task && task.dueDate !== dueDate) {
                    payload['dueDate'] = `${dueDate} 00:00:00`;
                }

                if (Object.keys(payload).length === 0) {
                    alert('Nothing to update');
                    return;
                }

                const response = await fetch(`${API_URI}/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem(ACCESS_TOKEN)
                    },
                    body: JSON.stringify(payload)
                });

                const json = await response.text();
                const obj = JSON.parse(json);
                
                if (response.ok) {
                    clearEditTaskForm();
                    alert('success');
                    getTasks('');
                } else {
                    alert(obj.message);
                }
            }

            async function deleteTask(taskId) {
                const response = await fetch(`${API_URI}/tasks/${taskId}`, {
                    method: 'DELETE',
                    headers: {
                        'Accept': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem(ACCESS_TOKEN)
                    },
                });

                const json = await response.text();
                const obj = JSON.parse(json);
                    
                if (response.status == 200) {
                    getTasks('');
                } else {
                    alert(obj.message);
                }
            }

            async function loginUser() {
                const response = await fetch(`${API_URI}/login`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: loginForm.inputEmail.value,
                        password: loginForm.inputPassword.value
                    })
                });

                const json = await response.text();
                const obj = JSON.parse(json);
                
                if (response.ok) {
                    localStorage.setItem(ACCESS_TOKEN, obj.data.access_token);
                    clearLoginForm(true);
                    getTasks('');
                } else {
                    clearLoginForm(false);
                    alert(obj.message);
                }
            }

            async function registerUser() {
                const response = await fetch(`${API_URI}/register`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: registerForm.inputName.value,
                        email: registerForm.inputEmail.value,
                        password: registerForm.inputPassword.value,
                        password_confirmation: registerForm.inputPasswordConfirmation.value,
                    })
                });

                const json = await response.text();
                const obj = JSON.parse(json);
                
                if (response.ok) {
                    clearRegisterForm(true);
                    alert('profile updated');
                } else {
                    clearRegisterForm(false);
                    alert(obj.message);
                }
            }

            async function updateUser() {
                const payload = {};

                if (user && user.name !== profileForm.inputName.value) {
                    payload['name'] = profileForm.inputName.value;
                }

                if (user && user.email !== profileForm.inputEmail.value) {
                    payload['email'] = profileForm.inputEmail.value;
                }

                if (profileForm.inputPassword.value) {
                    payload['password'] = profileForm.inputPassword.value;
                }

                if (profileForm.inputPasswordConfirmation.value) {
                    payload['password_confirmation'] = profileForm.inputPasswordConfirmation.value;
                }

                if (Object.keys(payload).length === 0) {
                    alert('Nothing to update');
                    return;
                }

                const response = await fetch(`${API_URI}/users`, {
                    method: 'PUT',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem(ACCESS_TOKEN)
                    },
                    body: JSON.stringify(payload)
                });

                const json = await response.text();
                const obj = JSON.parse(json);
                
                if (response.ok) {
                    clearProfileForm();
                    alert('success');
                } else {
                    clearProfileForm();
                    alert(obj.message);
                }
            }

            async function getUser() {
                const response = await fetch(`${API_URI}/users`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem(ACCESS_TOKEN)
                    },
                });

                const json = await response.text();
                const obj = JSON.parse(json);
                    
                if (response.ok) {
                    user = obj.data;
                    renderProfileForm(user);
                } else {
                    // logout
                    localStorage.removeItem(ACCESS_TOKEN);
                    renderDefaultView();
                }
            }

            async function logoutUser() {
                const response = await fetch(`${API_URI}/logout`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem(ACCESS_TOKEN)
                    },
                });

                const json = await response.text();

                localStorage.removeItem(ACCESS_TOKEN);
                renderDefaultView();

                if (!response.ok) {
                    const obj = JSON.parse(json);
                    alert(obj.message);
                }
            }
            
            async function createTask() {
                //required fields
                const payload = { title: createTaskForm.inputTitle.value, };

                let description = createTaskForm.inputDescription.value;
                if (description && description.trim()) {
                    payload['description'] = description.trim();
                }

                let completed = createTaskForm.inputCompleted.checked;
                if (completed) {
                    payload['completed'] = completed;
                }

                let dueDate = createTaskForm.inputDueDate.value;
                if (dueDate && dueDate.trim()) {
                    payload['dueDate'] = `${dueDate} 00:00:00`;
                }

                const response = await fetch(`${API_URI}/tasks`, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem(ACCESS_TOKEN)
                    },
                    body: JSON.stringify(payload)
                });

                const json = await response.text();
                const obj = JSON.parse(json);
                
                if (response.ok) {
                    getTasks('');
                } else {
                    alert(obj.message);
                }
            }

            /* RENDER DEFAULT VIEW */
            defaultViews();
        }

    </script>
</body>
</html>